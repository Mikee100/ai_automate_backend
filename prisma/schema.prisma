// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  whatsappId String? @unique // WhatsApp sender ID
  instagramId String? @unique // Instagram sender ID
  messengerId String? @unique // Messenger sender ID
  aiEnabled Boolean  @default(true) // AI enabled for this customer
  isAiPaused Boolean @default(false) // Pauses AI for this customer (e.g. during escalation)
  lastInstagramMessageAt DateTime? // Last inbound Instagram message for 24hr window tracking
  dailyTokenUsage Int @default(0) // Token usage counter for rate limiting
  tokenResetDate DateTime? // Date when token counter resets (24hr window)
  totalTokensUsed Int @default(0) // Lifetime token usage for analytics
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  Message[]
  bookings  Booking[]
  bookingDrafts BookingDraft[]
  escalations Escalation[]
  conversationMetrics ConversationMetrics[]
  photoLinks PhotoLink[]

  @@map("customers")
}

model Message {
  id        String   @id @default(cuid())
  content   String
  platform  String   // whatsapp, instagram, messenger, telegram
  direction String   // inbound, outbound
  customerId String
  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  externalId String? @unique // External message ID to prevent duplicates
  createdAt DateTime @default(now())
  handledBy String? // 'agent' or 'ai'
  isResolved Boolean?
  isEscalated Boolean?

  @@map("messages")
}

model Booking {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service     String
  dateTime    DateTime
  status      String   // provisional, confirmed, cancelled, completed
  durationMinutes Int? // duration in minutes for the service
  recipientName String?
  recipientPhone String?
  googleEventId String? @unique // Google Calendar event ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reminders   BookingReminder[]
  followups   PostShootFollowup[]

  @@map("bookings")
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String
  embedding Float[]  // vector for Pinecone
  mediaUrls String[] @default([]) // Array of image URLs to include in responses
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("knowledge_base")
}

model MediaAsset {
  id          String   @id @default(cuid())
  url         String   // Direct image/video URL
  title       String?  // Optional title/caption
  description String?  // Optional description
  category    String   // 'backdrop', 'portfolio', 'studio', 'outdoor', 'beach', 'family', etc.
  subcategory String?  // More specific categorization
  mediaType   String   @default("image") // 'image' or 'video'
  source      String   @default("website") // 'website', 'manual', 'upload'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("media_assets")
  @@index([category])
  @@index([subcategory])
}

model BookingDraft {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service     String?
  date        String?  // e.g., "2025-11-20"
  time        String?  // e.g., "9:00 AM"
  dateTimeIso String?  // ISO-8601 UTC string for scheduling
  name        String?
  recipientName String?
  recipientPhone String?
  isForSomeoneElse Boolean?
  step        String   // current step: service, date, time, name, confirm
  conflictResolution String? // Tracks user's choice when conflict: 'cancel_existing', 'modify_existing', 'different_time'
  version     Int      @default(1) // For optimistic locking
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payment     Payment?

  @@unique([customerId]) // One draft per customer
  @@map("booking_drafts")
}

model Package {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   // 'outdoor' or 'studio'
  price       Int      // in KSH
  deposit     Int      @default(2000) // deposit amount in KSH (default for migration)
  duration    String   // e.g., '2 hrs', '1 hr 30 mins'
  images      Int      // number of soft copy images
  makeup      Boolean  // professional makeup included
  outfits     Int      // number of own outfits
  styling     Boolean  // styling included
  photobook   Boolean  // photobook included
  photobookSize String? // e.g., '8x8"'
  mount       Boolean  // A3 mount included
  balloonBackdrop Boolean // Customised balloon backdrop included
  wig         Boolean  // Styled wig included
  notes       String?  // extra notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("packages")
}

model StudioInfo {
  id        String   @id @default(cuid())
  location  String
  notes     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("studio_info")
}

model Payment {
  id             String      @id @default(cuid())
  bookingDraftId String?     @unique
  bookingDraft   BookingDraft? @relation(fields: [bookingDraftId], references: [id], onDelete: SetNull)
  amount         Int         // deposit amount
  phone          String      // customer's phone for M-Pesa
  status         String      // pending, success, failed
  mpesaReceipt   String?     // M-Pesa receipt number
  checkoutRequestId String?  // M-Pesa CheckoutRequestID
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@map("payments")
}

model AiSettings {
  id        Int    @id @default(1)
  aiEnabled Boolean @default(true)
  updatedAt DateTime @updatedAt

  @@map("ai_settings")
}

model AiPrediction {
  id           Int      @id @default(autoincrement())
  timestamp    DateTime @default(now())
  input        String
  prediction   String
  actual       String?
  confidence   Float?
  responseTime Int      // ms
  error        String?
  userFeedback Int?     // 1-5 rating
  modelVersion String?
  tokensUsed   Int?     // Tokens consumed by this request
  wasCached    Boolean  @default(false) // Whether response was cached
}

model Escalation {
  id        String   @id @default(uuid())
  customerId String
  customer  Customer @relation(fields: [customerId], references: [id])
  reason    String?
  description String?
  status    String   @default("OPEN") // OPEN, RESOLVED
  escalationType String @default("manual") // manual, frustration, quota, error
  metadata  Json?    // Store sentiment analysis results and conversation context
  sentimentScore Float? // Frustration score (0.0 - 1.0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("escalations")
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // 'booking', 'reschedule', 'payment'
  title     String
  message   String
  metadata  Json?    // Flexible field for additional data
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("notifications")
  @@index([read, createdAt])
}

model ConversationMetrics {
  id            String   @id @default(cuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  intent        String   // booking, faq, escalation, etc.
  duration      Int      // conversation duration in seconds
  messagesCount Int      // number of messages exchanged
  resolved      Boolean  // whether issue was resolved
  timestamp     DateTime @default(now())

  @@map("conversation_metrics")
  @@index([customerId])
  @@index([timestamp])
  @@index([intent])
}

model PhotoLink {
  id         String   @id @default(cuid())
  link       String
  sentAt     DateTime @default(now())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("photo_links")
}

model BookingReminder {
  id           String   @id @default(cuid())
  bookingId    String
  booking      Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  type         String   // '48hr', '24hr', 'confirmation'
  scheduledFor DateTime
  sentAt       DateTime?
  status       String   @default("pending") // pending, sent, failed, cancelled
  messageContent String? // Store the actual message sent
  createdAt    DateTime @default(now())
  
  @@map("booking_reminders")
  @@index([bookingId])
  @@index([scheduledFor, status])
}

model PostShootFollowup {
  id           String   @id @default(cuid())
  bookingId    String
  booking      Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  type         String   // 'delivery', 'review_request', 'upsell'
  scheduledFor DateTime
  sentAt       DateTime?
  status       String   @default("pending") // pending, sent, failed, cancelled
  metadata     Json?    // Store additional data like review rating, upsell package
  messageContent String? // Store the actual message sent
  createdAt    DateTime @default(now())
  
  @@map("post_shoot_followups")
  @@index([bookingId])
  @@index([scheduledFor, status])
}
